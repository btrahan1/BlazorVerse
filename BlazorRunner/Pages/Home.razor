@page "/"
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>BlazorVerse Runner</PageTitle>

<!-- The 3D Canvas -->
<canvas id="renderCanvas"></canvas>

<!-- Top Left: Director Stats -->
<div class="hud-panel debug-panel">
    <div class="hud-header">🛰️ RUNNER STATS</div>
    <div class="hud-item">
        <span class="hud-label">FPS:</span>
        <span class="hud-value">@Stats.Fps.ToString("F0")</span>
    </div>
    <div class="hud-item">
        <span class="hud-label">RES:</span>
        <span class="hud-value">@Stats.Resolution</span>
    </div>
    <div class="hud-item" style="border-top: 1px solid rgba(0, 255, 0, 0.2); margin-top: 5px; padding-top: 5px;">
        <label class="hud-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" checked="@_fogEnabled" @onchange="ToggleFog" style="width: 15px; height: 15px; accent-color: #00ff00;" />
            🌫️ FOG
        </label>
    </div>
</div>

<!-- Center: Load Prompt -->
@if (!_sceneLoaded)
{
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 100;">
        <div style="background: rgba(0,0,0,0.8); padding: 40px; border: 2px solid #00ff00; border-radius: 10px; color: #00ff00;">
            <h1 style="margin-bottom: 30px;">BLAZORVERSE RUNNER</h1>
            <label class="btn-hud" style="font-size: 1.5em; padding: 15px 40px; background: #00ff00; color: #000; cursor: pointer;">
                📂 LOAD CARTRIDGE
                <InputFile OnChange="HandleFileLoad" style="display:none;" />
            </label>
            <p style="margin-top: 20px; font-size: 0.8em; opacity: 0.7;">Upload a .json scene to begin</p>
        </div>
    </div>
}

<!-- Mini Inspector: Driving only -->
@if (_selection != null && !_isDriving && _sceneLoaded)
{
    <div class="hud-panel inspector-panel" style="bottom: 20px; left: 50%; transform: translateX(-50%);">
        <div class="hud-header">🕹️ @(_selection.Name.ToUpper())</div>
        @if (_selection.Name.StartsWith("car") || _selection.Name.StartsWith("walker"))
        {
            <button class="btn-hud" style="background: linear-gradient(45deg, #ff9900, #ff5500); width: 100%;" @onclick="Drive">🏎️ DRIVE</button>
        }
    </div>
}

<!-- Drive Mode UI -->
@if (_isDriving)
{
    <div class="hud-panel" style="top: 20px; left: 50%; transform: translateX(-50%); text-align: center; border-color: #ffff00; color: #ffff00;">
        <div style="font-size: 2em; font-weight: bold;">
            ⏱️ @_raceTime.ToString("F2")
        </div>
    </div>
    
    <div class="hud-panel" style="bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; width: 300px;">
        <div class="hud-header">🏎️ DRIVING MODE</div>
        <div class="hud-item">Controls: W/A/S/D | ESC to Exit</div>
        
        <div style="margin: 15px 0; border-top: 1px solid rgba(0, 255, 0, 0.2); padding-top: 10px;">
            <div class="hud-label" style="margin-bottom: 5px;">🛠️ VEHICLE TUNING</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="hud-label" style="font-size: 0.7em;">POWER:</span>
                <input type="range" min="1" max="25" step="0.5" 
                       value="@_drivePower" 
                       @oninput="UpdateVehicleSpeed" 
                       style="flex: 1; accent-color: #00ff00;" />
                <span class="hud-value" style="width: 30px; font-size: 0.8em;">@_drivePower.ToString("F1")</span>
            </div>
        </div>

        <button class="btn-hud btn-hud-danger w-100 mt-2" @onclick="LeaveVehicle">LEAVE VEHICLE 🏃</button>
    </div>
}

@if (_raceFinished)
{
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 200;">
         <div style="background: rgba(0,0,0,0.9); padding: 50px; border: 4px solid #ffff00; border-radius: 15px;">
            <h1 style="color: #ffff00; font-size: 3em;">🏆 FINISHED!</h1>
            <h2 style="color: white;">TIME: @_finalTime.ToString("F2")s</h2>
            <button class="btn-hud mt-4" style="font-size: 1.5em; padding: 10px 30px;" @onclick="() => { _raceFinished = false; }">OK</button>
         </div>
    </div>
}

@code {
    private DotNetObjectReference<Home>? _objRef;
    private EngineStats Stats { get; set; } = new EngineStats();
    private SelectionInfo? _selection;
    private bool _isDriving = false;
    private bool _sceneLoaded = false;
    private float _drivePower = 5.0f;
    private double _raceTime = 0;
    private bool _raceFinished = false;
    private double _finalTime = 0;
    private bool _fogEnabled = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);

            // Wait for JS Module to attach to window
            int attempts = 0;
            while (attempts < 50) {
                try {
                    bool isReady = await JSRuntime.InvokeAsync<bool>("eval", "typeof window.BabylonInterop !== 'undefined'");
                    if (isReady) break;
                } catch { }
                await Task.Delay(100);
                attempts++;
            }

            await JSRuntime.InvokeVoidAsync("BabylonInterop.init", "renderCanvas", _objRef);
        }
    }

    private async Task Drive()
    {
        if (_selection == null) return;
        var id = _selection.Id;
        _isDriving = true;
        _selection = null;
        await JSRuntime.InvokeVoidAsync("BabylonInterop.setVehiclePower", _drivePower);
        await JSRuntime.InvokeVoidAsync("BabylonInterop.enterDriveMode", id);
    }

    private async Task UpdateVehicleSpeed(ChangeEventArgs e)
    {
        if (float.TryParse(e.Value?.ToString(), out float val))
        {
            _drivePower = val;
            await JSRuntime.InvokeVoidAsync("BabylonInterop.setVehiclePower", _drivePower);
        }
    }

    private async Task LeaveVehicle()
    {
        _isDriving = false;
        await JSRuntime.InvokeVoidAsync("BabylonInterop.exitDriveMode");
    }

    private async Task HandleFileLoad(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        using var stream = file.OpenReadStream();
        using var reader = new System.IO.StreamReader(stream);
        var json = await reader.ReadToEndAsync();
        await JSRuntime.InvokeVoidAsync("BabylonInterop.loadScene", json);
        await JSRuntime.InvokeVoidAsync("BabylonInterop.setEditorCameraMode", "walk");
        _sceneLoaded = true;
        StateHasChanged();
    }

    [JSInvokable]
    public void SelectObject(string name, string id, double x, double y, double z)
    {
        _selection = new SelectionInfo { Name = name, Id = id, X = x, Y = y, Z = z };
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdateStats(double fps, double x, double y, double z, int meshCount, string cameraType, string lightType, string res, int verts)
    {
        Stats.Fps = fps;
        Stats.Resolution = res;
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdateTimer(double time)
    {
        _raceTime = time;
        StateHasChanged();
    }

    [JSInvokable]
    public void OnRaceFinished(double finalTime)
    {
        _raceFinished = true;
        _finalTime = finalTime;
        _isDriving = false; 
        StateHasChanged();
    }

    private async Task ToggleFog(ChangeEventArgs e)
    {
        _fogEnabled = (bool)(e.Value ?? true);
        await JSRuntime.InvokeVoidAsync("BabylonInterop.toggleFog", _fogEnabled);
    }

    public async ValueTask DisposeAsync()
    {
        try {
            await JSRuntime.InvokeVoidAsync("BabylonInterop.dispose");
        } catch {}
        _objRef?.Dispose();
    }
}
