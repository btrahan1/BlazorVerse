@page "/"
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>BlazorVerse</PageTitle>

<!-- The 3D Canvas -->
<canvas id="renderCanvas"></canvas>

<!-- Top Left: Director Stats -->
<div class="hud-panel debug-panel">
    <div class="hud-header">üõ∞Ô∏è DIRECTOR STATS</div>
    <div class="hud-item">
        <span class="hud-label">FPS:</span>
        <span class="hud-value" style="color: @(Stats.Fps < 30 ? "#ff0000" : "#00ff00")">@Stats.Fps.ToString("F0")</span>
    </div>
    <div class="hud-item">
        <span class="hud-label">RES:</span>
        <span class="hud-value">@Stats.Resolution</span>
    </div>
    <div class="hud-item" style="border-top: 1px solid rgba(0, 255, 0, 0.2); margin-top: 5px; padding-top: 5px;">
        <span class="hud-label">CAM:</span>
        <span class="hud-value">@Stats.CameraType</span>
    </div>
    <div class="hud-item">
        <span class="hud-label">POS:</span>
        <span class="hud-value">@Stats.X.ToString("F1"), @Stats.Y.ToString("F1"), @Stats.Z.ToString("F1")</span>
    </div>
    <div class="hud-item" style="border-top: 1px solid rgba(0, 255, 0, 0.2); margin-top: 5px; padding-top: 5px;">
        <span class="hud-label">LIGHTS:</span>
        <span class="hud-value">@Stats.LightType</span>
    </div>
    <div class="hud-item">
        <span class="hud-label">MESHES:</span>
        <span class="hud-value">@Stats.MeshCount</span>
    </div>
     <div class="hud-item">
        <span class="hud-label">VERTS:</span>
        <span class="hud-value">@Stats.Vertices.ToString("N0")</span>
    </div>
</div>

<!-- Top Right: Control Center -->
@if (!_isDriving)
{
    <div class="hud-panel control-panel">
        <div class="hud-header">üéõÔ∏è CONTROL CENTER</div>
        
        <div class="hud-item">
            <span class="hud-label">ENTITY:</span>
        </div>
        <select class="hud-input" style="width: 100%; margin-bottom: 10px;" @bind="_selectedShape">
            <option value="box">Cube üì¶</option>
            <option value="sphere">Sphere üîÆ</option>
            <option value="wall">Wall üß±</option>
            <option value="car">Car üöó</option>
            <option value="walker">Walker ü§ñ</option>
            <option value="finish">Finish Line üèÅ</option>
        </select>
        
        <button class="btn-hud w-100 mb-2" @onclick="AddShape">SPAWN ENTITY</button>

        <div style="border-top: 1px solid rgba(0, 255, 0, 0.2); margin-top: 10px; padding-top: 10px;">
            <div class="hud-label">CAMERA MODE:</div>
            <div style="display: flex; gap: 5px;">
                <button class="btn-hud @(_cameraMode == "orbit" ? "active" : "")" style="flex: 1;" @onclick='() => SetCameraMode("orbit")'>ü¶Ö ORBIT</button>
                <button class="btn-hud @(_cameraMode == "walk" ? "active" : "")" style="flex: 1;" @onclick='() => SetCameraMode("walk")'>üö∂ WALK</button>
            </div>
        </div>
    </div>
}

<!-- Drive Mode UI -->
@if (_isDriving)
{
    <div class="hud-panel" style="top: 20px; left: 50%; transform: translateX(-50%); text-align: center; border-color: #ffff00; color: #ffff00;">
        <div style="font-size: 2em; font-weight: bold;">
            ‚è±Ô∏è @_raceTime.ToString("F2")
        </div>
    </div>

    <div class="hud-panel" style="bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; width: 300px;">
        <div class="hud-header">üèéÔ∏è DRIVING MODE</div>
        <div class="hud-item">Controls: W/A/S/D</div>
        
        <div style="margin: 15px 0; border-top: 1px solid rgba(0, 255, 0, 0.2); padding-top: 10px;">
            <div class="hud-label" style="margin-bottom: 5px;">üõ†Ô∏è VEHICLE TUNING</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="hud-label" style="font-size: 0.7em;">POWER:</span>
                <input type="range" min="1" max="25" step="0.5" 
                       value="@_drivePower" 
                       @oninput="UpdateVehicleSpeed" 
                       style="flex: 1; accent-color: #00ff00;" />
                <span class="hud-value" style="width: 30px; font-size: 0.8em;">@_drivePower.ToString("F1")</span>
            </div>
        </div>

        <button class="btn-hud btn-hud-danger w-100 mt-2" @onclick="LeaveVehicle">LEAVE VEHICLE üèÉ</button>
    </div>
}

@if (_raceFinished)
{
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 200;">
         <div style="background: rgba(0,0,0,0.9); padding: 50px; border: 4px solid #ffff00; border-radius: 15px;">
            <h1 style="color: #ffff00; font-size: 3em;">üèÜ FINISHED!</h1>
            <h2 style="color: white;">TIME: @_finalTime.ToString("F2")s</h2>
            <button class="btn-hud mt-4" style="font-size: 1.5em; padding: 10px 30px;" @onclick="() => { _raceFinished = false; }">OK</button>
         </div>
    </div>
}

<!-- World Editor Toggle (Top Right, below Control Center) -->
@if (!_isDriving)
{
    <button class="btn-hud" style="position: absolute; top: 220px; right: 20px; width: 220px;" @onclick="() => _showWorldEditor = !_showWorldEditor">
        üåç WORLD EDITOR
    </button>
}

<!-- World Editor Panel -->
@if (_showWorldEditor && !_isDriving)
{
    <div class="hud-panel" style="top: 270px; right: 20px; width: 220px;">
        <div class="hud-header">üåã TERRAFORM</div>
        
        <div class="hud-label">GROUND:</div>
        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
            <button class="btn-hud" style="flex: 1; font-size: 20px;" @onclick='() => SetGround("sand.jpg")' title="Sand">üèúÔ∏è</button>
            <button class="btn-hud" style="flex: 1; font-size: 20px;" @onclick='() => SetGround("grass.png")' title="Grass">üåø</button>
            <button class="btn-hud" style="flex: 1; font-size: 20px;" @onclick='() => SetGround("rock.png")' title="Rock">ü™®</button>
            <button class="btn-hud" style="flex: 1; font-size: 20px;" @onclick='() => SetGround("wood.jpg")' title="Wood">ü™µ</button>
            <button class="btn-hud" style="flex: 1; font-size: 20px;" @onclick='() => SetGround("floor.png")' title="Tile">‚¨ú</button>
        </div>

        <div class="hud-label">ATMOSPHERE:</div>
         <div style="display: flex; gap: 5px; margin-bottom: 20px;">
            <button class="btn-hud" style="flex: 1; background: #c1440e;" @onclick='() => SetAtmosphere("mars")'>MARS</button>
            <button class="btn-hud" style="flex: 1; background: #2196f3;" @onclick='() => SetAtmosphere("earth")'>EARTH</button>
            <button class="btn-hud" style="flex: 1; background: #1a237e;" @onclick='() => SetAtmosphere("night")'>NIGHT</button>
        </div>

        <div class="hud-item" style="margin-bottom: 15px;">
            <label class="hud-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" checked="@_fogEnabled" @onchange="ToggleFog" style="width: 20px; height: 20px; accent-color: #00ff00;" />
                üå´Ô∏è ENABLE FOG
            </label>
        </div>

        <div class="hud-header" style="font-size: 0.8em; margin-top: 10px;">üíæ SERIALIZATION</div>
        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
            <button class="btn-hud" style="flex: 1; background: #4caf50;" @onclick="ExportScene">EXPORT JSON</button>
            <button class="btn-hud" style="flex: 1; background: #ffeb3b; color: #000;" @onclick="ImportScene">LOAD JSON</button>
        </div>

        <div class="hud-label">FILENAME:</div>
        <input class="hud-input" style="width: 100%; margin-bottom: 5px;" @bind="_fileName" placeholder="scene_name" />

        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button class="btn-hud" style="flex: 1; background: #2e7d32;" @onclick="SaveToFile">üíæ SAVE FILE</button>
            <label class="btn-hud" style="flex: 1; background: #fbc02d; color: #000; cursor: pointer; text-align: center; line-height: 25px;">
                üìÇ LOAD FILE
                <InputFile OnChange="HandleFileLoad" style="display:none;" />
            </label>
        </div>

        @if (!string.IsNullOrEmpty(_sceneJson))
        {
            <textarea class="hud-input" style="width: 100%; height: 100px; font-family: monospace; font-size: 10px;" @bind="_sceneJson"></textarea>
            <button class="btn-hud w-100 mt-1" style="font-size: 0.7em" @onclick='() => _sceneJson = ""'>CLEAR DATA</button>
        }
    </div>
}

<!-- Bottom Center: Inspector -->
@if (_selection != null && !_isDriving)
{
    <div class="hud-panel inspector-panel">
        <div class="hud-header">
            üîç INSPECTOR
            <span class="hud-close" @onclick="ClearSelection">X</span>
        </div>
        
        <div class="hud-item">
            <span class="hud-label">NAME:</span>
            <span class="hud-value">@_selection.Name</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">POS:</span>
            <span class="hud-value">X:@_selection.X.ToString("F2") Y:@_selection.Y.ToString("F2") Z:@_selection.Z.ToString("F2")</span>
        </div>
        
        <div class="mt-3">
            <button class="btn-hud" @onclick="ChangeColor">üé® COLOR</button>
            <button class="btn-hud" @onclick="ResetPos">üìç RESET</button>
            <button class="btn-hud btn-hud-danger" @onclick="Delete">üóëÔ∏è DELETE</button>

            @if (_selection.Name.StartsWith("car") || _selection.Name.StartsWith("walker"))
            {
               <button class="btn-hud" style="background: linear-gradient(45deg, #ff9900, #ff5500); margin-top: 10px;" @onclick="Drive">üèéÔ∏è DRIVE</button>
            }
        </div>
    </div>
}

@code {
    private DotNetObjectReference<Home>? _objRef;
    private EngineStats Stats { get; set; } = new EngineStats();
    private string _selectedShape = "box";
    private SelectionInfo? _selection;
    private bool _isDriving = false;
    private float _drivePower = 5.0f;
    private double _raceTime = 0;
    private bool _raceFinished = false;
    private double _finalTime = 0;
    private bool _fogEnabled = true;
    private string _cameraMode = "orbit";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            
            // Wait for JS Module to attach to window
            int attempts = 0;
            while (attempts < 50) {
                try {
                    bool isReady = await JSRuntime.InvokeAsync<bool>("eval", "typeof window.BabylonInterop !== 'undefined'");
                    if (isReady) break;
                } catch { }
                await Task.Delay(100);
                attempts++;
            }

            await JSRuntime.InvokeVoidAsync("BabylonInterop.init", "renderCanvas", _objRef);
        }
    }

    private async Task AddShape() => await JSRuntime.InvokeVoidAsync("BabylonInterop.addShape", _selectedShape);
    private async Task ChangeColor() => await JSRuntime.InvokeVoidAsync("BabylonInterop.changeColor", _selection?.Id);
    private async Task ResetPos() => await JSRuntime.InvokeVoidAsync("BabylonInterop.resetPos", _selection?.Id);
    private async Task Delete() 
    {
        await JSRuntime.InvokeVoidAsync("BabylonInterop.deleteMesh", _selection?.Id);
        _selection = null;
    }
    
    private async Task Drive()
    {
        if (_selection == null) return;
        var id = _selection.Id;
        _isDriving = true;
        _selection = null; // Clear selection UI
        await JSRuntime.InvokeVoidAsync("BabylonInterop.setVehiclePower", _drivePower);
        await JSRuntime.InvokeVoidAsync("BabylonInterop.enterDriveMode", id);
    }

    private async Task UpdateVehicleSpeed(ChangeEventArgs e)
    {
        if (float.TryParse(e.Value?.ToString(), out float val))
        {
            _drivePower = val;
            await JSRuntime.InvokeVoidAsync("BabylonInterop.setVehiclePower", _drivePower);
        }
    }

    private async Task LeaveVehicle()
    {
        _isDriving = false;
        await JSRuntime.InvokeVoidAsync("BabylonInterop.exitDriveMode");
    }

    // World Editor Logic
    private bool _showWorldEditor = false;

    private async Task SetGround(string texture)
    {
        await JSRuntime.InvokeVoidAsync("BabylonInterop.setGroundTexture", texture);
    }

    private async Task SetAtmosphere(string preset)
    {
        if (preset == "mars") await JSRuntime.InvokeVoidAsync("BabylonInterop.setAtmosphere", 0.8, 0.5, 0.2, 0.005);
        if (preset == "earth") await JSRuntime.InvokeVoidAsync("BabylonInterop.setAtmosphere", 0.2, 0.6, 0.9, 0.001);
        if (preset == "night") await JSRuntime.InvokeVoidAsync("BabylonInterop.setAtmosphere", 0.05, 0.05, 0.1, 0.01);
    }

    private async Task ToggleFog(ChangeEventArgs e)
    {
        _fogEnabled = (bool)(e.Value ?? true);
        await JSRuntime.InvokeVoidAsync("BabylonInterop.toggleFog", _fogEnabled);
    }

    private async Task SetCameraMode(string mode)
    {
        _cameraMode = mode;
        await JSRuntime.InvokeVoidAsync("BabylonInterop.setEditorCameraMode", mode);
    }

    private string _sceneJson = "";
    private string _fileName = "blazorverse_scene";

    private async Task ExportScene()
    {
        _sceneJson = await JSRuntime.InvokeAsync<string>("BabylonInterop.exportScene");
        StateHasChanged();
    }

    private async Task ImportScene()
    {
        if (string.IsNullOrEmpty(_sceneJson)) return;
        await JSRuntime.InvokeVoidAsync("BabylonInterop.loadScene", _sceneJson);
    }

    private async Task SaveToFile()
    {
        var json = await JSRuntime.InvokeAsync<string>("BabylonInterop.exportScene");
        var name = string.IsNullOrWhiteSpace(_fileName) ? "scene" : _fileName;
        if (!name.EndsWith(".json")) name += ".json";
        await JSRuntime.InvokeVoidAsync("BabylonInterop.downloadFile", name, json);
    }

    private async Task HandleFileLoad(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        using var stream = file.OpenReadStream();
        using var reader = new System.IO.StreamReader(stream);
        _sceneJson = await reader.ReadToEndAsync();
        await JSRuntime.InvokeVoidAsync("BabylonInterop.loadScene", _sceneJson);
        StateHasChanged();
    }

    private void ClearSelection() => _selection = null;

    [JSInvokable]
    public void SelectObject(string name, string id, double x, double y, double z)
    {
        _selection = new SelectionInfo { Name = name, Id = id, X = x, Y = y, Z = z };
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdateStats(double fps, double x, double y, double z, int meshCount, string cameraType, string lightType, string res, int verts)
    {
        Stats.Fps = fps;
        Stats.X = x; Stats.Y = y; Stats.Z = z;
        Stats.MeshCount = meshCount;
        Stats.CameraType = cameraType;
        Stats.LightType = lightType;
        Stats.Resolution = res;
        Stats.Vertices = verts;
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdateTimer(double time)
    {
        _raceTime = time;
        StateHasChanged();
    }

    [JSInvokable]
    public void OnRaceFinished(double finalTime)
    {
        _raceFinished = true;
        _finalTime = finalTime;
        _isDriving = false; 
        StateHasChanged();
    }

    public class EngineStats
    {
        public double Fps { get; set; }
        public double X { get; set; }
        public double Y { get; set; }
        public double Z { get; set; }
        public int MeshCount { get; set; }
        public string CameraType { get; set; } = "";
        public string LightType { get; set; } = "";
        public string Resolution { get; set; } = "";
        public int Vertices { get; set; }
    }

    public class SelectionInfo
    {
        public string Name { get; set; } = "";
        public string Id { get; set; } = "";
        public double X { get; set; }
        public double Y { get; set; }
        public double Z { get; set; }
    }

    public async ValueTask DisposeAsync()
    {
        try {
            await JSRuntime.InvokeVoidAsync("BabylonInterop.dispose");
        } catch {}
        _objRef?.Dispose();
    }
}
